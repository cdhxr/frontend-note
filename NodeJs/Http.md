# idea of http

- Httpåœ¨TCP,UDPå±‚ä¹‹ä¸Š
- æ˜¯ä¸€ä¸ªåè®®ï¼Œprotocolï¼Œæ„å‘³ç€ä¸€ç»„è§„åˆ™
- httpå¯ä»¥æŒ‡å®šJSONæ•°æ®ï¼Œå†…éƒ¨ç”±é”®å€¼å¯¹æ„æˆ
- æ‰€æœ‰ç½‘ç«™ä½¿ç”¨httpè¿›è¡Œé€šä¿¡ï¼Œåªè¦ä½¿ç”¨æµè§ˆå™¨ï¼Œå°±ä¸éœ€è¦ä»»ä½•ç¼–ç¨‹ï¼ŒæŒ‡å®šåŸŸåï¼Œå¯ä»¥è®¿é—®ä¸–ç•Œä¸Šæ•°åäº¿è®¡ç®—æœº
- httpä¸ä¼šä¸ºä¸¤ä¸ªäº’è”ç½‘ä¸Šçš„è®¡ç®—æœºå»ºç«‹è¿æ¥ï¼Œè¿™æ˜¯lower layerçš„jobï¼ŒTCP-UDP,IPé“¾è·¯ï¼Œç½‘ç»œå±‚çš„å·¥ä½œï¼Œä¹Ÿä¸ä¼šä¼ è¾“æ•°æ®ï¼Œé‚£æ˜¯æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚çš„å·¥ä½œ
- httpåšçš„äº‹æƒ…æ˜¯ï¼Œç»„ç»‡ä½¿ç”¨TCP-UDPå±‚ä¼ è¾“çš„æ•°æ®
	- å®ƒè§„å®šäº†æ•°æ®çš„å½¢å¼ï¼Œæ¯”å¦‚å‰8ä½æ˜¯headerï¼Œè¿™ç§è§„åˆ™


# client-server model

- åˆ›å»ºTCP connectionï¼Œä½¿å…¶å¯ä»¥äº¤æ¢æ•°æ®
- å®¢æˆ·ç«¯ send first TCP segementï¼ŒåŒ…æ‹¬headers And methods And URL
- å®¢æˆ·ç«¯ send body chunksï¼Œclientä¼šæŒ‡å®šè¿™ä¸ªmessageçš„end
- ä¸Šé¢çš„ä¸¤æ¬¡sendçš„ä¸œè¥¿ï¼Œåˆç§°ä¸ºä¸€ä¸ªmessageï¼ˆheader And bodyï¼‰
- æœåŠ¡ç«¯è¯†åˆ«åˆ°endçš„æ ‡è¯†ï¼Œæ”¶åˆ°äº†messageï¼Œä¼šè¿›è¡Œresponse
- æœåŠ¡ç«¯ç¬¬ä¸€ä¸ªå‘é€çš„ä¸œè¥¿æ˜¯statusï¼ŒåŒ…æ‹¬status textå’Œstatus code
- æœåŠ¡ç«¯ç´§æ¥ç€ä¼šsendå“åº”headerï¼Œé€šå¸¸å’Œstatus stuffä¸€èµ·å‘é€ï¼Œåœ¨åŒä¸€ä¸ªTCP segement
- ç„¶åï¼Œserverå†sendæ­£æ–‡éƒ¨åˆ†ï¼Œå¦‚æœæ•°æ®å¾ˆå¤§åˆ™å¯èƒ½ä»¥chunkçš„å½¢å¼å‘é€ï¼ŒåŒæ ·æœ€ç»ˆç”±endæ ‡è¯†
- æœåŠ¡ç«¯ä¸Šè¿°å‘é€çš„ä¸œè¥¿ï¼ŒåŒæ ·è¢«ç§°ä¸ºmessageï¼ˆæ­£æ–‡ï¼Œstatuså’Œheadersï¼‰

- å®¢æˆ·ç«¯å‘é€çš„messageä¸ºrequestï¼ŒæœåŠ¡ç«¯å‘é€çš„messageä¸ºresponse

![[Pasted image 20250526125835.png]]

è¿™ç§æœºåˆ¶æ˜¯å¿…é¡»è¦ç­‰åˆ°requestæ‰èƒ½responseï¼Œå¹¶éœ€è¦ååº”responseæ—¶é—´çš„ï¼Œæ‰€ä»¥Httpåè®®ä¸é€‚åˆæ„å»ºç±»ä¼¼äºå¤§å‹èŠå¤©å®¤ï¼ˆå¦åˆ™ä¼šå¾ˆæ…¢ï¼‰çš„åº”ç”¨ï¼Œ
è¿™ç§æƒ…å†µï¼Œå°±è¦ç”¨åˆ°å…¶ä»–çš„åè®®ï¼Œæ¯”å¦‚webSocketï¼Œå®ƒå…è®¸serverä¸æ”¶åˆ°requestï¼Œè€Œç›´æ¥send message
httpä¸­å¿…é¡»è¦ç­‰åˆ°requestæ‰èƒ½responseï¼Œæœ‰è¯·æ±‚ï¼Œæ‰èƒ½å‘å®¢æˆ·ç«¯å‘é€æ•°æ®

# æ¶ˆæ¯äº¤æ¢åï¼ŒTCPè¿æ¥çš„çŠ¶æ€

- æ¶ˆæ¯äº¤æ¢åï¼ŒTCPä¸Šçš„messageä¼šç«‹åˆ»æ¶ˆå¤±
	- ä½†æµè§ˆå™¨äº‹å®ä¸Šå¯ä»¥Cacheç¼“å­˜å®ƒä»¬ï¼Œå³å°†bodyä¸­çš„æ–‡ä»¶ï¼Œå­˜åœ¨å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯ç»ˆç«¯çš„ç¡¬ç›˜æˆ–è€…å†…å­˜ä¸­ï¼Œå¯¹äºç›¸åŒæ–‡ä»¶çš„è¯·æ±‚ï¼Œå°†çœå»æ„å»ºTCPè¿æ¥çš„æ­¥éª¤ï¼Œç›´æ¥ä»æœ¬æœºä¸­è¯»å–
	- æ„å»ºTCPè¿æ¥åªéœ€è¦å‡ msï¼Œä½†äº‹å®ä¸Šç”¨æˆ·ä¸€ä¸ªå‡ºç°å¤§é‡è¯·æ±‚çš„ä¾‹å­æ˜¯å¾ˆå¸¸è§çš„ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½é‡å¤æ„å»ºè¿æ¥çš„è¯ï¼Œå°†ä¼šé€ æˆæ€§èƒ½é—®é¢˜

- åœ¨ä¿¡æ¯äº¤æ¢åï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å¯¹TCPè¿æ¥closedæˆ–è€…keep-alive
- å…·ä½“çš„è¯´é€šè¿‡ï¼Œåœ¨headerä¸­ä½¿ç”¨Connection headerçš„è®¾ç½®æ¥å®ç°
	- è®¾ç½®ä¸ºclosedé‚£ä¹ˆæœªæ¥çš„è¯·æ±‚å°†é‡æ–°æ„å»ºä¸€ä¸ªTCPè¿æ¥
	- è®¾ç½®ä¸ºkeep-aliveé‚£ä¹ˆæœªæ¥çš„è¯·æ±‚å°†ä¼šå¤ç”¨ç›¸åŒè¿æ¥ï¼Œè€Œçœå»é‡æ–°æ„å»ºçš„è¿‡ç¨‹
- æ˜¾ç„¶ï¼Œåè€…æ˜¯æ›´ä¼˜çš„ï¼Œå½“ç”¨æˆ·é‡å¤§æ—¶ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ä¸€äº›ç­–ç•¥å»åˆ‡æ–­ä¸€äº›è¿æ¥ï¼Œé¿å…å‡ºç°é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼Œ8ç§’ä¸æ“ä½œå°±ä¼šåˆ‡æ–­ï¼Œè¶…è¿‡maxå€¼æ—¶ï¼Œä¼šæ ¹æ®ç®—æ³•åˆ‡æ–­ä¸€äº›å·²æœ‰è¿æ¥ï¼Œä»¥åˆ›å»ºæ–°è¿æ¥
	- ![[Pasted image 20250526164949.png]]

- å› ä¸ºè®¾ç½®çš„æ™®éæ€§ï¼Œä¸Šè¿°çš„ä¸¤ä¸ªheaderåœ¨http2å’Œhttp3æ—¶ä¸å†è¢«é‡‡ç”¨ï¼Œå˜ä¸ºdefaultè®¾ç½®


# Http Mouduleå¯ä»¥åœ¨net moduleåŸºç¡€ä¸Šæ„å»º

Httpå°±æ˜¯å»ºç«‹äº†ä¸€ä¸ªTCPè¿æ¥ç„¶åè¿›è¡Œäº†æ•°æ®çš„ä¼ è¾“ï¼Œä¹Ÿå¯ä»¥æ„å»ºåœ¨UDPä¸Šï¼ˆæ¯”å¦‚Http3ï¼‰

## å‘é€Httpè¯·æ±‚æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ

- ä½¿ç”¨synchronous numberï¼ˆç¡®ä¿è¿æ¥è¢«å»ºç«‹ï¼Œç¡®ä¿æ–­ç‚¹å­˜åœ¨ï¼Œå…è®¸å‘é€æ•°æ®ï¼‰å»ºç«‹TCPè¿æ¥
- TCP window updateï¼ˆæ»‘åŠ¨çª—å£æ›´æ–°ï¼‰ï¼Œä¼šå…ˆè¿›è¡Œæ»‘åŠ¨çª—å£çš„æ‰©å¼ ï¼Œå¢å¤§æ•°æ®ååé‡ï¼Œç›´åˆ°é˜ˆå€¼
...
ç­‰ç­‰å»ºç«‹TCPè¿æ¥çš„æ“ä½œ

- Httpè¯·æ±‚packageï¼ŒåŒ…æ‹¬headerï¼Œbodyï¼ŒJSONæ•°æ®ç­‰ç­‰å®Œæ•´çš„request
- TCPç¡®ä¿æ•°æ®è¢«æ­£ç¡®ä¼ è¾“
- Httpå“åº”package

- Httpé€šè¿‡ **0d 0a 0d 0a** ....æ¥ä½œä¸ºç‰¹æ®Šçš„åˆ†ç•Œç¬¦å·ï¼ŒåŒºåˆ†headerå’Œbodyéƒ¨åˆ†
- content-lengthï¼Œå³**0d 0a 0d 0a**åçš„content-lengthæ˜¯Httpè¯·æ±‚body
- æŒ‡å®šcontent-lengthåï¼Œä¼šåœ¨æ”¶åˆ°å“åº”å­—èŠ‚çš„æ•°æ®æ—¶æ‰ä¼šç»“æŸè¯·æ±‚ï¼ˆè§¦å‘endäº‹ä»¶ï¼‰

## ä½¿ç”¨net Moduleçš„clientå‘é€Httpè¯·æ±‚

é€šè¿‡wiresharkï¼Œå°†headerï¼Œbodyä»¥åŠåˆ†éš”ç¬¦ç­‰ç­‰çš„packageå®Œæ•´çš„åå…­è¿›åˆ¶æ•°æ®å¤åˆ¶ä¸‹æ¥

ç›´æ¥é€šè¿‡net moduleåˆ›å»ºçš„clientä¸­çš„Socket.writeå†™å…¥å¯¹åº”çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå¯ä»¥åœ¨wiresharkä¸­å¾—åˆ°å®Œå…¨ä¸€æ ·çš„ç»“æœ

è¿™è¯´æ˜äº†Http ModuleæŸç§æ„ä¹‰ä¸ŠåŸºäºnet Moduleï¼Œç»“åˆHttpåè®®å°è£…æˆä¸ºäº†net Module

Http Moduleå¸®åŠ©æˆ‘ä»¬è§£æè¿™ä¸ª16è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå‘Šè¯‰æˆ‘ä»¬ï¼Œå“ªé‡Œæ˜¯headerå“ªé‡Œæ˜¯bodyè¿™å°±æ˜¯Httpæ¨¡å—çš„ä½œç”¨ï¼Œå…¶ä»–åº•å±‚çš„å·¥ä½œéƒ½æ˜¯net Moduleåšåˆ°çš„

## ä½¿ç”¨net Moduleçš„Serveræ¥æ”¶Httpè¯·æ±‚

å¯ä»¥ä½¿ç”¨PostManå‘net.Serveråˆ›å»ºçš„æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œå¯ä»¥æ¥å—åˆ°headerå’Œbodyï¼Œ

ä½†æ˜¯åœ¨PostManå¾—åˆ°ç›¸åŒçš„ä¿¡æ¯æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œéœ€è¦è‡ªå·±å®ç°å¯¹**0d 0a 0d 0a** è¿™äº›åˆ†éš”ç¬¦çš„è§£æé€»è¾‘ï¼Œä¸åƒHttpæ¨¡å—å¯ä»¥è½»æ˜“åšåˆ°è¿™ä¸€ç‚¹ï¼Œåœ¨net Moduleä¸­éœ€è¦è‡ªå·±å®ç°

è¿™ä¹Ÿæ˜¯Httpè¢«ç§°ä¸ºæ˜æ–‡åè®®çš„åŸå› ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥æ¥å—åˆ°æ„ä¹‰çš„ä¿¡æ¯ï¼Œè¿™ä¹Ÿå¸¦æ¥ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œæ¯”å¦‚Nextjsæœ€è¿‘çš„å®‰å…¨äº‹ä»¶ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡ŒåŠ å¯†


# MIME TYPE

åœ¨ HTTP åè®®ä¸­ï¼Œ`Content-Type` æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å¤´å­—æ®µï¼ˆHeaderï¼‰ï¼Œå®ƒç”¨æ¥å‘Šè¯‰æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯ï¼š

> **è¿™ä¸ª HTTP æ¶ˆæ¯ä½“ï¼ˆbodyï¼‰ä¸­çš„å†…å®¹å±äºå“ªç§ç±»å‹ï¼ˆæ ¼å¼ï¼‰ï¼Ÿ**

---

## ğŸ§© ä¸€ã€`Content-Type` æ˜¯ä»€ä¹ˆï¼Ÿ

`Content-Type` é€šå¸¸ç”¨äº `HTTP è¯·æ±‚` æˆ– `å“åº”` ä¸­ï¼ŒæŒ‡å®šæ¶ˆæ¯ä½“çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿè¢«ç§°ä¸º **MIME ç±»å‹ï¼ˆMedia Typeï¼‰**ã€‚

**åŸºæœ¬æ ¼å¼ï¼š**

```
Content-Type: <åª’ä½“ç±»å‹>/<å­ç±»å‹>; charset=<å­—ç¬¦é›†>
```

ä¾‹å¦‚ï¼š

```
Content-Type: text/html; charset=UTF-8
Content-Type: application/json
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary
```

---

## ğŸ“¦ äºŒã€ä»€ä¹ˆæ˜¯ Media Typeï¼ˆMIME ç±»å‹ï¼‰ï¼Ÿ

**Media Type** æ˜¯ä¸€ç§æ ‡å‡†ï¼Œç”¨æ¥æ ‡è¯†æ–‡ä»¶çš„å†…å®¹ç±»å‹ï¼Œå®ƒæœ€åˆç”¨äºç”µå­é‚®ä»¶ï¼Œç°åœ¨åœ¨ HTTP ä¸­å¹¿æ³›ä½¿ç”¨ã€‚

å®ƒç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š

```
ä¸»ç±»å‹ / å­ç±»å‹
```

### å¸¸è§ä¸»ç±»å‹æœ‰ï¼š

|ä¸»ç±»å‹|è¯´æ˜|
|---|---|
|`text`|æ–‡æœ¬æ ¼å¼ï¼Œå¦‚ `text/html`|
|`image`|å›¾ç‰‡æ ¼å¼ï¼Œå¦‚ `image/png`|
|`audio`|éŸ³é¢‘æ ¼å¼ï¼Œå¦‚ `audio/mpeg`|
|`video`|è§†é¢‘æ ¼å¼ï¼Œå¦‚ `video/mp4`|
|`application`|åº”ç”¨æ•°æ®ï¼Œå¦‚ `application/json`|
|`multipart`|å¤šéƒ¨åˆ†æ•°æ®ï¼Œå¦‚è¡¨å•ä¸Šä¼ |

---

## ğŸ¯ ä¸‰ã€å¸¸è§ Content-Type ç±»å‹ä¸¾ä¾‹

| Content-Type                        | ç”¨é€”è¯´æ˜            |
| ----------------------------------- | --------------- |
| `text/plain`                        | çº¯æ–‡æœ¬             |
| `text/html`                         | HTML æ–‡æ¡£         |
| `text/css`                          | CSS æ ·å¼è¡¨         |
| `application/javascript`            | JavaScript è„šæœ¬   |
| `application/json`                  | JSON æ ¼å¼çš„æ•°æ®      |
| `application/xml`                   | XML æ ¼å¼çš„æ•°æ®       |
| `application/x-www-form-urlencoded` | è¡¨å•é»˜è®¤æäº¤æ ¼å¼ï¼ˆé”®å€¼å¯¹ï¼‰   |
| `multipart/form-data`               | è¡¨å•ä¸Šä¼ æ–‡ä»¶æ—¶ä½¿ç”¨çš„æ ¼å¼    |
| `application/octet-stream`          | ä»»æ„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¸¸ç”¨äºæ–‡ä»¶ä¸‹è½½ |

---

## ğŸ§  å››ã€å¼€å‘ä¸­å¦‚ä½•ç”¨ï¼Ÿ

### 1. å‰ç«¯å‘é€ JSONï¼š

```http
POST /api
Content-Type: application/json

{
  "name": "chatgpt"
}
```

### 2. è¡¨å•æäº¤ï¼ˆé»˜è®¤ï¼‰ï¼š

```http
POST /submit
Content-Type: application/x-www-form-urlencoded

username=tom&password=1234
```

### 3. æ–‡ä»¶ä¸Šä¼ ï¼ˆå¸¦è¾¹ç•Œçš„ multipartï¼‰ï¼š

```http
POST /upload
Content-Type: multipart/form-data; boundary=----ABC123

------ABC123
Content-Disposition: form-data; name="file"; filename="img.png"
Content-Type: image/png

<binary data>
------ABC123--
```

---

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> `Content-Type` å°±åƒæ˜¯å‘Šè¯‰æœåŠ¡å™¨æˆ–æµè§ˆå™¨ï¼šâ€œå˜¿ï¼Œæˆ‘è¿™æ®µå†…å®¹æ˜¯æŸç§æ ¼å¼çš„ï¼Œè¯·æŒ‰è¿™ä¸ªæ ¼å¼æ¥ç†è§£æˆ‘ï¼â€


# HTTP Methods

## idempotent å¹‚ç­‰æ€§

å³å¤šæ¬¡æ“ä½œä¸ä¼šé€ æˆä¸ç¬¬ä¸€æ¬¡æ‰§è¡Œä¹‹å¤–çš„å½±å“ï¼Œå³åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æœ‰ç”¨ï¼Œæ¥ä¸‹æ¥å‡ æ¬¡éƒ½ä¸ä¼šæœ‰ä»»ä½•å½±å“

## methods

| æ–¹æ³•å       | ä½œç”¨æè¿°          | æ˜¯å¦å®‰å…¨ | æ˜¯å¦å¹‚ç­‰ | æ˜¯å¦æœ‰è¯·æ±‚ä½“ | æ˜¯å¦æœ‰å“åº”ä½“ |
| --------- | ------------- | ---- | ---- | ------ | ------ |
| `GET`     | è·å–èµ„æº          | âœ… æ˜¯  | âœ… æ˜¯  | âŒ å¦    | âœ… æ˜¯    |
| `POST`    | æäº¤æ•°æ®åˆ›å»ºèµ„æº      | âŒ å¦  | âŒ å¦  | âœ… æ˜¯    | âœ… æ˜¯    |
| `PUT`     | æ›´æ–°æ•´ä¸ªèµ„æºï¼ˆæˆ–åˆ›å»ºï¼‰   | âŒ å¦  | âœ… æ˜¯  | âœ… æ˜¯    | âœ… å¯é€‰   |
| `PATCH`   | å±€éƒ¨æ›´æ–°èµ„æº        | âŒ å¦  | âœ…å¯èƒ½  | âœ… æ˜¯    | âœ… å¯é€‰   |
| `DELETE`  | åˆ é™¤èµ„æº          | âœ… å¯é€‰ | âœ… æ˜¯  | âœ… å¯é€‰   | âœ… å¯é€‰   |
| `HEAD`    | è·å–èµ„æºçš„å¤´éƒ¨ï¼ˆæ— å“åº”ä½“ï¼‰ | âœ… æ˜¯  | âœ… æ˜¯  | âŒ å¦    | âŒ å¦    |
| `OPTIONS` | æŸ¥è¯¢æœåŠ¡å™¨æ”¯æŒå“ªäº›æ–¹æ³•   | âœ… æ˜¯  | âœ… æ˜¯  | âŒ å¦    | âœ… å¯é€‰   |
|           |               |      |      |        |        |

- getï¼Œä¸ºäº†requestï¼Œæ²¡æœ‰è¯·æ±‚ä½“ï¼ˆbodyï¼‰ï¼Œæ˜¯å¹‚ç­‰çš„
- Postï¼Œä¸ºäº†åˆ›å»ºèµ„æºæˆ–è€…æ‰§è¡ŒæŸä¸ªactionï¼Œæœ‰è¯·æ±‚bodyå’Œå“åº”bodyï¼Œå¹¶ä¸å¹‚ç­‰
	- ä½ å¯ä»¥ä½¿ç”¨Postè¯·æ±‚ï¼Œæ‰§è¡Œå¹‚ç­‰çš„æ“ä½œï¼Œä½†é‚£ç§æƒ…å†µï¼Œåº”è¯¥ä½¿ç”¨Putæˆ–è€…PATCH
- HEADï¼Œåªç”¨æ¥å¾—åˆ°header
- OPTIONS 

# HTTP STATUS CODE

only use for responses
we
100~599

- 100~199ï¼šinformational responses
- 200~299ï¼šsucessful response
- 300~399ï¼šfor redirectionï¼Œè¯·æ±‚é‡å®šå‘
- 400~499ï¼šclient errorsï¼Œ
- 500~599ï¼šServer errorsï¼Œå‘é€äº†ä¸œè¥¿ä½†æ— æ³•å¤„ç†

ä¸è¦ä¸ºæ‰€æœ‰é”™è¯¯éƒ½åˆ†é…500çš„é”™è¯¯ï¼ŒåŒºåˆ†400å’Œ500å¯ä»¥æ›´å¥½çš„ç¡®å®šè¯·æ±‚å¤±è´¥æ˜¯å› ä¸ºå‰ç«¯è¿˜æ˜¯åç«¯ï¼Œæœ€å¥½ä½¿ç”¨è§„èŒƒä¸­æ›´æœ‰æè¿°æ€§çš„code

# HTTP Proxies

å¤šä¸ªæœåŠ¡å™¨è¿è¡Œç›¸åŒçš„ç¨‹åºååˆ†æ™®éï¼Œè¿™æ ·å¯ä»¥åˆ†æ‘Šæµé‡ï¼Œå¯ä»¥é¿å…å› å•ä¸€æœåŠ¡å™¨ç˜«ç—ªï¼Œä½¿æ•´ä¸ªåº”ç”¨ç˜«ç—ªçš„é£é™©

è®¸å¤šclientçš„æµé‡å¦‚ä½•è¢«åˆ†é…ï¼Ÿ

è¿™äº›clientsä¼šå…ˆå‘åˆ°HTTP proxyï¼ˆæœ‰è‡ªå·±çš„ä¸€ä¸ªIPåœ°å€ï¼‰

**HTTP Proxyï¼ˆHTTPä»£ç†ï¼‰** æ˜¯ä»‹äºå®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨ï¼‰ä¸æœåŠ¡å™¨ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´æœåŠ¡å™¨ï¼Œå®ƒæ¥å—å®¢æˆ·ç«¯çš„ HTTP è¯·æ±‚ï¼Œå°†å…¶è½¬å‘ç»™ç›®æ ‡æœåŠ¡å™¨ï¼Œç„¶åå°†æœåŠ¡å™¨çš„å“åº”å†è½¬å‘å›å®¢æˆ·ç«¯ã€‚

åˆ†é…æµé‡çš„åœºæ™¯ï¼Œè¿™ä¸ªproxyè¢«ç§°ä½œLoad Balancer

LoadBalancerå¾€å¾€æ˜¯ç»è¿‡æ£€éªŒçš„ï¼Œå®‰å…¨çš„æœåŠ¡å™¨ï¼Œè€Œä¸€èˆ¬çš„Serveråœ¨æ¨å‡ºä¸€ä¸ªæ–°åŠŸèƒ½æ—¶ï¼Œå¾ˆå®¹æ˜“å› ä¸ºä¸ç¡®å®šæ€§å› ç´ å½±å“

HTTP Proxyè¿˜æœ‰å…¶ä»–åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚blockä¸€äº›æ¶æ„è¯·æ±‚ç­‰ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨LoadBalancerä¸clientsä¹‹é—´è¿˜æœ‰ä¸€å±‚HTTP proxyçš„æƒ…å†µ

è¿™ä¸ªProxyä½¿ç”¨HTTP 3ï¼ˆåŸºäºUDPï¼‰ï¼Œå› ä¸ºå®¢æˆ·ç«¯å’Œproxyçš„è·ç¦»å¯èƒ½å¾ˆè¿œï¼Œå¯¹é€Ÿåº¦æœ‰æ›´é«˜çš„è¦æ±‚ï¼Œè€ŒæœåŠ¡å™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å¾€å¾€æ˜¯é›†ä¸­ç®¡ç†ï¼Œç”¨ç¨³å®šå…‰çº¤ä¼ è¾“ï¼Œæ‰€ä»¥å³ä½¿ç”¨HTTP 1ä¹Ÿå¯ä»¥

```js
const http = require("http");

// The proxy's port
const PORT = 9000;

// List of our backend servers
const mainServers = [
  { host: "localhost", port: 9001 },
  { host: "localhost", port: 9002 },
];

// Create the proxy server
const proxy = http.createServer();

proxy.on("request", (clientRequest, proxyResponse) => {
  // Select a server to route the incoming request to (using round-robin algorithm)
  const mainServer = mainServers.shift();
  mainServers.push(mainServer);

  // The request that we are sending to one of our main servers
  const proxyRequest = http.request({
    host: mainServer.host,
    port: mainServer.port,
    path: clientRequest.url,
    method: clientRequest.method,
    headers: clientRequest.headers,
  });

  // Once we receive a response from one of our main servers
  proxyRequest.on("response", (mainServerResponse) => {
    // Set the status code and headers for the response that we are sending to the client
    proxyResponse.writeHead(
      mainServerResponse.statusCode,
      mainServerResponse.headers
    );

    // Finally write the body of the main server's response to the body of proxy's response
    // and send the response to the client
    mainServerResponse.pipe(proxyResponse);
  });

  // Write the body of the client's request to the body of proxy's request being sent
  // to one of our servers
  clientRequest.pipe(proxyRequest);
});

proxy.listen(PORT, () => {
  console.log(`Proxy server is running on port ${PORT}`);
});
```

è¿™ä¸ªç¨‹åºçš„ä½œç”¨æ˜¯ï¼š

- ç›‘å¬æœ¬åœ°ç«¯å£ `9000`ï¼›
- ä½¿ç”¨ **è½®è¯¢ç®—æ³• (Round-Robin)** æŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™ `localhost:9001` å’Œ `localhost:9002` ä¸¤ä¸ªä¸»æœåŠ¡å™¨ä¹‹ä¸€ï¼›
- å†æŠŠä¸»æœåŠ¡å™¨çš„å“åº”åŸæ ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

# HTTP stateless

HTTPçš„æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹å¤„ç†çš„ï¼Œä¸ä¼šä¿ç•™ä»»ä½•çŠ¶æ€æˆ–è€…æ•°æ®ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨ä¸ä¼šè®°å¾—ä¸Šä¸€æ¬¡ä½ åšè¿‡ä»€ä¹ˆ

æ¯æ¬¡ä½ è®¿é—®ç½‘é¡µã€æäº¤è¡¨å•ï¼Œéƒ½ä¼šå‘é€ä¸€ä¸ª HTTP è¯·æ±‚ã€‚æœåŠ¡å™¨ä¼šå¤„ç†å¹¶è¿”å›å“åº”ï¼Œä½†æ˜¯ï¼š

- **å¤„ç†å®Œè¿™æ¬¡è¯·æ±‚ä¹‹åï¼ŒæœåŠ¡å™¨å°±â€œå¿˜è®°â€äº†ä½ æ˜¯è°**ï¼›
- ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨æ— æ³•é€šè¿‡ HTTP æœ¬èº«â€œè®°ä½â€ä½ æ˜¯ä¸Šæ¬¡æ¥çš„é‚£ä¸ªç”¨æˆ·ã€‚

| åŸå›      | è§£é‡Š                          |
| ------ | --------------------------- |
| âœ… ç®€å•æ€§  | æœåŠ¡å™¨åªéœ€å¤„ç†å½“å‰è¯·æ±‚ï¼Œä¸å¿…ç»´æŠ¤ç”¨æˆ·çŠ¶æ€ï¼Œé€»è¾‘æ›´ç®€å•ã€‚ |
| âœ… æ‰©å±•æ€§å¥½ | å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´ä¸éœ€è¦å…±äº«ç”¨æˆ·ä¼šè¯çŠ¶æ€ï¼Œæ–¹ä¾¿åšè´Ÿè½½å‡è¡¡ã€‚ |
| âœ… çµæ´»æ€§å¼º | ç”¨æˆ·æ¯æ¬¡è¯·æ±‚éƒ½å¯ä»¥ç‹¬ç«‹è·¯ç”±åˆ°ä¸åŒæœåŠ¡å™¨ã€‚        |
### ä¸¾ä¸ªæ —å­ ğŸŒ°

ä½ æ‰“å¼€ç”µå•†ç½‘ç«™ï¼Œåšäº†è¿™äº›äº‹ï¼š

1. è®¿é—®ä¸»é¡µï¼ˆGET `/`ï¼‰
2. ç™»å½•è´¦å·ï¼ˆPOST `/login`ï¼‰
3. è®¿é—®è´­ç‰©è½¦ï¼ˆGET `/cart`ï¼‰
    

å¯¹äºæœåŠ¡å™¨æ¥è¯´ï¼š

- ç¬¬1æ­¥å’Œç¬¬3æ­¥æ¯«æ— å…³è”ï¼Œé™¤éä½ ä¸»åŠ¨â€œæä¾›èº«ä»½ä¿¡æ¯â€ï¼ˆæ¯”å¦‚ cookieï¼‰ï¼›
- HTTP æœ¬èº«ä¸ä¼šè®°å½•â€œä½ å·²ç»ç™»å½•â€è¿™ä¸ªçŠ¶æ€ã€‚

![[Pasted image 20250606114424.png]]

å› æ­¤ï¼Œå®ƒæ˜¯ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç™»å½•è¿‡çš„ï¼Œé‚£ä¹ˆå¦‚ä½•é‰´æƒï¼Ÿ

# Token

![[Pasted image 20250606120558.png]]

å°†Tokençš„ä½œç”¨å¯ä»¥ç†è§£ä¸ºèº«ä»½è¯æˆ–è€…å­¦ç”Ÿè¯ï¼Œæƒ³åšä»€ä¹ˆäº‹ï¼Œæ£€æŸ¥è¯ä»¶ï¼Œåªè¦æœ‰ä»–ä»¬ï¼Œå°±èƒ½å¤Ÿå…è®¸æ”¾è¡Œ

ç™»å½•çš„è¿‡ç¨‹ï¼š

- clientè¾“å…¥ç”¨æˆ·å¯†ç å‘é€ç™»å½•è¯·æ±‚
- åˆ°LoadBalanceråˆ†é…åˆ°ä¸€ä¸ªServerï¼Œ
- å‘æ•°æ®åº“æœåŠ¡å™¨å‘é€è¯·æ±‚æ¯”å¯¹ç”¨æˆ·åå¯†ç 
- æˆåŠŸåˆ™åœ¨Serverç”ŸæˆTokenï¼Œå‘é€ç»™æ•°æ®åº“å’Œå®¢æˆ·ç«¯ï¼ˆç»è¿‡ä»£ç†ï¼‰
- å‘é€è¯·æ±‚æ—¶ï¼Œå°†headerä¸­ä»£ç€Tokenï¼ŒServerè®¿é—®æ•°æ®åº“æ£€æŸ¥Token
- æ­¤æ—¶ï¼Œå³ä½¿è¢«åˆ†é…åˆ°ä¸ç”ŸæˆTokenä¸åŒçš„Serverä¸Šä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºæ˜¯ä»æ•°æ®åº“ä¸­æ£€ç´¢è€Œä¸æ˜¯Server
- æœ‰æ•ˆåˆ™è¿”å›å“åº”æ•°æ®

TCPæ˜¯æœ‰çŠ¶æ€çš„ï¼Œä¼šè®°ä½sourceå’Œdestinationï¼Œä¼škeepä¸¤è€…çš„Socketå’ŒçŠ¶æ€ï¼Œäº‹å®ä¸Šå¯ä»¥é€šè¿‡TCPå®ç°é‰´æƒï¼Œä½†æ˜¯ä¸€æ—¦æ–­ç½‘æˆ–è€…åˆ‡æ¢ç½‘ç»œï¼ŒTCPå°±è¦é‡æ–°å»ºç«‹ï¼Œæ‰€ä»¥ç€æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•

é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•ä¿å­˜Tokenå‘¢

- å¦‚æœå®¢æˆ·ç«¯åªæ˜¯ä¸€ä¸ªnodejs clientï¼Œå¯ä»¥å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨fs module
- å¦‚æœå®¢æˆ·ç«¯æ˜¯æµè§ˆå™¨å‘¢ï¼Ÿï¼ˆå¾ˆæ™®éçš„ä¸€ç§æƒ…å†µï¼‰

# HTTP COOKIES

å¦‚æœæ”¶åˆ°äº†Cookieï¼Œå®¢æˆ·ç«¯ä¼šåœ¨åç»­è¯·æ±‚ä¸­è‡ªåŠ¨æºå¸¦è¿™äº›æ•°æ®è¿”å›æœåŠ¡å™¨ã€‚

Cookie æ˜¯æµè§ˆå™¨â€œè‡ªåŠ¨è®°ä½çš„ä¸€å¼ å°çº¸æ¡â€ï¼ŒæœåŠ¡å™¨äº¤ç»™å®ƒä¿å­˜ï¼Œä¸‹æ¬¡è®¿é—®å°±å¸¦å›æ¥ã€‚

- æœåŠ¡å™¨é€šè¿‡ï¼ŒsetCookieæ˜¯ç”¨äºè®¾ç½®Cookieçš„headerï¼Œå‘é€ç»™client
- clientä¼šå°†Cookieä¿å­˜åœ¨diskä¸­ï¼Œåœ¨åç»­çš„è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸€ä¸ªCookie header
- ä¸åŒçš„Cookieä¼šé€šè¿‡ï¼›é—´éš”ï¼Œå¤šä¸ªCookieä¼šåœ¨åŒä¸€ä¸ªheaderä¸­è¢«ä¼ è¾“
- cookie headeråªç”¨äºrequestï¼Œset-cookie headeråªç”¨äºresponse
- cookie headerå¯ä»¥è®¾ç½®å¤šä¸ªå€¼ï¼Œset-cookie headeråªèƒ½è®¾ç½®ä¸€ä¸ªå€¼

| å±æ€§                    | è¯´æ˜                                                   |
| --------------------- | ---------------------------------------------------- |
| `Name=Value`          | å…³é”®å†…å®¹ï¼šé”®å€¼å¯¹                                             |
| `Expires` æˆ– `Max-Age` | è®¾å®š Cookie ç”Ÿå‘½å‘¨æœŸ                                       |
| `Path`                | æŒ‡å®šå“ªäº›è·¯å¾„å¯ä»¥å¸¦ä¸Šè¿™ä¸ª Cookie                                  |
| `Domain`              | æŒ‡å®šå“ªäº›åŸŸåå¯è®¿é—®è¿™ä¸ª Cookie                                   |
| `HttpOnly`            | åªèƒ½åœ¨ HTTP è¯·æ±‚ä¸­ä½¿ç”¨ï¼ŒJavaScript æ— æ³•è®¿é—®ï¼Œé˜²æ­¢ XSS æ”»å‡»             |
| `Secure`              | åªåœ¨ HTTPS è¿æ¥ä¸­ä¼ è¾“                                       |
| `SameSite`            | æ§åˆ¶æ˜¯å¦å…è®¸è·¨ç«™ç‚¹å‘é€ Cookieï¼ˆåº”å¯¹ CSRFï¼‰å€¼å¯ä¸ºï¼š`Strict`ã€`Lax`ã€`None` |
ä¹Ÿæœ‰ä¸€äº›Cookieçš„æ›¿ä»£ï¼Œæ¯”å¦‚localStorageå’Œindexdbç±»ä¼¼çš„web APIï¼Œè¿™æ˜¯å‰ç«¯çš„è¯é¢˜

# middlewareä¸­é—´ä»¶

å¾ˆå¤šè¯·æ±‚éƒ½éœ€è¦ä¸€äº›é¢„å…ˆçš„é‡å¤çš„é€»è¾‘ï¼Œæ¯”å¦‚æƒé™çš„ç¡®å®šï¼Œé‰´æƒ

```js
const token = req.headers.cookie.split("=")[1];

  const session = SESSIONS.find((session) => session.token === token);
  if (session) {
    // the actuall method
	...
  } else {
    res.status(401).json({ error: "Unauthorized" });
  }
```

middlewareæƒ³åšçš„äº‹æƒ…æ˜¯

```js
// è°ƒç”¨è·¯ç”±æŒ‡å®šçš„æ–¹æ³•
this.routes[req.method.toLowerCase() + req.url](req,res); 
```

åœ¨æ”¶åˆ°requestï¼Œè°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæ‰§è¡Œä¸€æ®µé€šç”¨çš„é€»è¾‘

```js
server.beforeEach((req, res, next) => {
  // This function will run before every request
  // You can use it to set headers, log requests, etc.
  ...
});
```

éœ€è¦è®¾ç½®ä¸€ä¸ªnextä½œä¸ºcallbackå‡½æ•°ï¼Œå› ä¸ºè¿™é‡Œçš„é€»è¾‘é€šå¸¸æ˜¯ä¸€äº›å¼‚æ­¥çš„åŠŸèƒ½ï¼Œä¸ºäº†è®©å¼‚æ­¥åŠŸèƒ½æŒ‰é¡ºåºå·¥ä½œ

middlewareè®¾è®¡äº†ä¸€å¥—ï¼Œå¿…é¡»è°ƒç”¨nextæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªmiddlewareå‡½æ•°çš„æœºåˆ¶ï¼Œä¸è°ƒç”¨nextè¿™ä¸ªcbå°±ä¸ä¼šè°ƒç”¨å…¶ä»–çš„middlewareå‡½æ•°ï¼Œé¿å…äº†å¼‚æ­¥æ“ä½œçš„ä¹±åºï¼Œå°±ç±»ä¼¼äºasyncï¼Œawait





